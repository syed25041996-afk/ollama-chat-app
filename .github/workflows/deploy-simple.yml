name: Deploy to Server

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null\n" > ~/.ssh/config

      - name: Run command on server
        run: |
          ssh -i ~/.ssh/id_ed25519 \
              home@0.tcp.in.ngrok.io -p 16809 \
              "echo 'âœ… Secure deployment from GitHub Actions'"

      - name: Run deploy script on server
        run: |
          ssh -i ~/.ssh/id_ed25519 \
              home@0.tcp.in.ngrok.io -p 16809 \
              "cd /home/home/apps/ollama-chat-app && ./deploy.sh"
